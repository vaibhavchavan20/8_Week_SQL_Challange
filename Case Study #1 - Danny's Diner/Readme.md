# Case Study #1: Danny's Diner

## ðŸ“‹ Case Study Overview

In this case study, we are tasked with helping Danny, the owner of a small restaurant, analyze his business data. The goal is to help him better understand customer behavior, optimize sales strategies, and improve operational efficiency. The case study involves queries focusing on simple aggregations, joins, and date-based filtering.

### View the detailed case study on [www.8weeksqlchallange.com](https://8weeksqlchallenge.com/case-study-1/)

## ðŸ“ Objectives

The main objectives of the case study are:
- Understanding customer purchase behavior.
- Analyzing total sales and revenue generated by the diner.
- Identifying patterns of frequent diners and how their spending changes over time.

## ðŸ”§ How to Use

In this folder, you will find the following files:
- **Database_Creation_Queries.sql**: This .sql file contains all queries to create database and tables.
- **Questions and Answers Queries.sql**: This file contains all the queries used to answer the case study questions.
- **Questions And Answers with Queries and Output.pdf**: Each question is answered with the query and the output generated.

  **Note: All Solutions are coded with MySQL**

## ðŸ“‘ Table of Contents

1. **Q1: What is the total amount each customer spent at the restaurant?**
```sql
SELECT
sales.customer_id,
SUM(menu.price) AS 'Total Spending in $'
FROM sales
INNER JOIN menu ON
sales.product_id=menu.product_id
GROUP BY sales.customer_id
ORDER BY sales.customer_id;
```
| customer_id | Total Spending in $ |
|-------------|-------------|
| A           | 76          |
| B           | 74          |
| C           | 36          |


2. **Q2: How many days has each customer visited the restaurant?**
```sql
SELECT
	customer_id,
    COUNT(DISTINCT(order_date)) AS days_visited
FROM sales
GROUP BY customer_id;
```
| customer_id | days_visited |
|-------------|--------------|
| A           | 4            |
| B           | 6            |
| C           | 2            |

3. **Q3. What was the first item from the menu purchased by each Customer?**
```sql
SELECT 
		customer_id,
        product_name AS first_purchased_product
FROM
    (SELECT 
		sales.customer_id,
		menu.product_name,
		DENSE_RANK() OVER( PARTITION BY sales.customer_id ORDER BY sales.order_date) As rnk
	FROM sales
	INNER JOIN menu ON sales.product_id=menu.product_id) AS sales_rank
WHERE rnk = 1
GROUP BY customer_id,product_name;
```
| customer_id | first_purchased_product |
|-------------|-----------------------|
| A           | sushi                 |
| A           | curry                 |
| B           | curry                 |
| C           | ramen                 |

4. **Q4. What is the most purchased item on the menu and how many times was it purchased by all customers?**
- This question needs to be solved in two parts, in part 1, we'll find the most purchased item and in part 2, we'll find how mny times its purchased by all customers
```sql
-- Part 1

SELECT 
	menu.product_name AS 'Most purchased Product',
    COUNT(sales.product_id) AS 'Purchase Count'
FROM sales 
INNER JOIN menu 
	ON sales.product_id = menu.product_id
GROUP BY menu.product_name
ORDER BY COUNT(sales.product_id) DESC
LIMIT 1;                                           -- this gives the most purchased item on menu
```
| Most purchased Product | Purchase Count |
|---------------------|----------------|
| ramen               | 8              |

```sql
-- Part 2

SELECT 
	sales.customer_id,
    COUNT(sales.product_id) AS purchase_count
FROM sales
INNER JOIN menu ON sales.product_id = menu.product_id
WHERE sales.product_id = (SELECT product_id FROM sales
							GROUP BY product_id
                            ORdER BY count(product_id)
                            DESC LIMIT 1)
GROUP BY sales.customer_id
ORDER BY purchase_count DESC;                    -- this gives the list of customers who have purchased highest purchased item
```
| customer_id | purchase_count |
|-------------|----------------|
| A           | 3              |
| B           | 2              |
| C           | 3              |

5. **Q5. Which item was the most popular for each customer?**
```sql
WITH cte_popular_products as ( 
	SELECT 
		sales.customer_id,
		menu.product_name,
		COUNT(*) as purchase_count,
		DENSE_RANK() OVER( PARTITION BY sales.customer_id 
						ORDER BY COUNT(*) DESC) AS rnk
	FROM sales
	INNER JOIN menu ON sales.product_id = menu.product_id
	GROUP BY sales.customer_id, menu.product_name )
SELECT 
	customer_id,
    product_name,
    purchase_count
FROM cte_popular_products
WHERE rnk=1;
```
| customer_id | product_name | purchase_count |
|-------------|--------------|----------------|
| A           | ramen        | 3              |
| B           | curry        | 2              |
| B           | sushi        | 2              |
| B           | ramen        | 2              |
| C           | ramen        | 3              |


6. **Q6. Which item was purchased first by the customer after they became a member?**
```sql
WITH cte_after_membership AS (
  SELECT
    members.customer_id, 
    sales.product_id,
    DENSE_RANK() OVER (
      PARTITION BY members.customer_id
      ORDER BY sales.order_date) AS densrank
  FROM members
  INNER JOIN sales
    ON members.customer_id = sales.customer_id
    AND sales.order_date > members.join_date
)
SELECT 
  cte_after_membership.customer_id, 
  menu.product_name 
FROM cte_after_membership
INNER JOIN menu
  ON cte_after_membership.product_id = menu.product_id
WHERE densrank = 1
ORDER BY cte_after_membership.customer_id ASC;
```
| customer_id | product_name |
|-------------|--------------|
| A           | ramen        |
| B           | sushi        |

7. **Q7. Which item was purchased just before the customer became a member?**
```sql
WITH cte_after_membership AS (
  SELECT
    members.customer_id, 
    sales.product_id,
    DENSE_RANK() OVER (
      PARTITION BY members.customer_id
      ORDER BY sales.order_date) AS densrank
  FROM members
  INNER JOIN sales
    ON members.customer_id = sales.customer_id
    AND sales.order_date < members.join_date
)
SELECT 
  cte_after_membership.customer_id, 
  menu.product_name 
FROM cte_after_membership
INNER JOIN menu
  ON cte_after_membership.product_id = menu.product_id
WHERE densrank = 1
ORDER BY cte_after_membership.customer_id ASC;
```
| customer_id | product_name |
|-------------|--------------|
| A           | sushi        |
| A           | curry        |
| B           | curry        |

8. **Q8. What is the total items and amount spent for each member before they became a member?**
```sql
SELECT
	sales.customer_id,
    COUNT(sales.product_id) AS total_items,
    SUM(menu.price) AS total_amt_spent
FROM sales
JOIN members ON sales.customer_id = members.customer_id
JOIN menu ON sales.product_id = menu.product_id
WHERE sales.order_date < members.join_date
group by sales.customer_id
ORDER BY sales.customer_id;
```
| customer_id | total_items | total_amt_spent |
|-------------|-------------|--------------------|
| A           | 2           | 25                 |
| B           | 3           | 40                 |

9. **Q9. If each $1 spent equates to 10 points and sushi has a 2x points multiplier, how many points would each customer have?**
```sql
SELECT 
    sales.customer_id,
    SUM(menu.price) AS total_price,
    SUM(CASE
        WHEN menu.product_name = 'sushi' THEN menu.price * 20
        ELSE menu.price * 10
    END) AS total_points
FROM sales
	JOIN menu ON sales.product_id = menu.product_id
GROUP BY customer_id;
```
| customer_id | total_price | total_points |
|-------------|-------------|--------------------|
| A           | 76          | 860                |
| B           | 74          | 940                |
| C           | 36          | 360                |

10. **Q10. In the first week after a customer joins the program (including their join date), they earn 2x points on all items, not just sushi. How many points do customers A and B have at the end of January?**
```sql
SELECT 
	sales.customer_id,
    SUM(menu.price) AS total_price,
    SUM(CASE 
			WHEN sales.order_date BETWEEN members.join_date AND DATE_ADD(members.join_date, INTERVAL 6 DAY) THEN menu.price*20
			ELSE 
				CASE WHEN menu.product_name = 'sushi' THEN menu.price * 20
				ELSE menu.price * 10
				END
			END) AS points
FROM sales
INNER JOIN menu ON sales.product_id = menu.product_id
INNER JOIN members ON sales.customer_id = members.customer_id
WHERE sales.order_date <= '2021-01-31'
AND sales.customer_id IN ('A','B')
GROUP BY sales.customer_id
ORDER BY sales.customer_id;
```
| customer_id | total_price | points |
|-------------|-------------|--------|
| A           | 76          | 1370   |
| B           | 62          | 820    |

4. **Q4. What is the most purchased item on the menu and how many times was it purchased by all customers?**







4. **Q4. What is the most purchased item on the menu and how many times was it purchased by all customers?**

For a detailed walkthrough of this case study, visit the video on [iThinkData YouTube channel](https://www.youtube.com/@iThinkData).
